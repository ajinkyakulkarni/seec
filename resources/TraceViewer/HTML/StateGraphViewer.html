<html>
 <head>
  <script src="icurb://TraceViewer/StateGraphViewer/jquery-1.8.2.min.js" type="text/javascript"></script>
  <link href="icurb://TraceViewer/StateGraphViewer/Styles.css" rel="stylesheet" type="text/css" />

  <script type="text/javascript">
    var SeeCProto = "";
    var StateExists = false;
    var HighlightedValues = [];

    // Clear the debug log.
    //
    function LogClear() {
      document.getElementById("Log").innerHTML = "";
    }

    // Add a debug message to the log.
    //
    function Log(Message) {
      var Container = document.getElementById("Log");
      
      Container.innerHTML = Container.innerHTML
			    + "<span>" + Message
                            + "</span><br>";
    }

    // Build the URL for a SeeC function request.
    //
    function SeeCURL(fn, args) {
      var str = SeeCProto + "://" + fn;

      for (var i = 0; i < args.length; ++i)
        str += "/" + args[i];

      str += "?callback=?";
      return str;
    }

    function NotifyContextMenu() {
      $.getJSON(SeeCURL("notify_contextmenu", ["foo"]),
        function(data) { /* The result is not important. */ });
    }

    function NotifyHover(nodeid) {
      $.getJSON(SeeCURL("notify_hover", [nodeid]),
        function(data) { /* The result is not important. */ });
    }

    function NodeMouseEnter(e) {
      var $this = $(this);
      var href = $this.attr('xlink:href');
      if (!href) {
        Log("No xlink:href found.");
        return false;
      }

      NotifyHover(href);
    }

    function NodeMouseLeave(e) {
      NotifyHover("null");
    }

    // Highlight a Value.
    //

    function HighlightValueImpl(ValueID) {
      $('a').each(function() {
        var $this = $(this);
        var href = $this.attr('xlink:href');
        if (!href) {
          Log("No xlink:href found.");
          return false;
        }

        var splitref = href.split(' ');
        if (splitref.length != 2) {
          Log("Bad reference length.");
          return false;
        }

        if (splitref[0] == "value" && splitref[1] == ValueID) {
          var Elem = $this[0];
          var Class = Elem.className.baseVal;
          Class += ' ' + "valuehighlight";
          Elem.setAttribute("class", Class);

          for (var i = 0; i < Elem.childNodes.length; ++i) {
            var Child = Elem.childNodes[i];
            if (Child.nodeName == "polygon") {
              Child.setAttribute("fill", "rgb(220,255,220)");
              Child.setAttribute("fill-opacity", 0.5);
            }
          }
        }
      });
    }

    // Called from seec-trace-viewer to set a new state display.
    //
    var SetStateImplTimer = null;
    
    function SetStateImpl(SVGString) {
      SetStateImplTimer = null;
      
      var Container = document.getElementById("SVGContainer");
      Container.innerHTML = SVGString;

      $('title').remove();

      var refs = $('a');
      refs.removeAttr("xlink:title");
      refs.hover(NodeMouseEnter, NodeMouseLeave);

      StateExists = true;

      for (var i = 0; i < HighlightedValues.length; ++i)
        HighlightValueImpl(HighlightedValues[i]);
    }
    
    function SetState(SVGString) {
      if (SetStateImplTimer != null)
        window.clearTimeout(SetStateImplTimer);
      
      StateExists = false;
      LogClear();
      
      SetStateImplTimer = setTimeout(function() { SetStateImpl(SVGString); },
                                     0);
    }

    // Called from seec-trace-viewer to indicate that our state is out of date.
    //
    function InvalidateState() {
      HighlightedValues = [];
    }

    // Called from seec-trace-viewer to clear the state display.
    //
    function ClearState() {
      StateExists = false;
      HighlightedValues = [];
      document.getElementById("SVGContainer").innerHTML = "";
    }

    // Called from seec-trace-viewer to highlight a value.
    //
    function HighlightValue(ValueID) {
      HighlightedValues.push(ValueID);
      if (StateExists)
        HighlightValueImpl(ValueID);
    }

    // Initial page setup.
    //
    function DoSetup() {
      if (window.location.hash.length)
        SeeCProto = window.location.hash.substring(1);

      $(document).bind("contextmenu", function(e) {
        NotifyContextMenu();
        return false;
      });
    }

    function WaitForSetup() {
      if (typeof jQuery === 'function') {
        $(DoSetup);
      }
      else {
        setTimeout(WaitForSetup, 50);
      }
    }

    WaitForSetup();
  </script>
 </head>
 <body>
  <div id="SVGContainer"></div>
  <div id="Log"></div>
 </body>
</html>

