<html>
 <head>
  <script src="icurb://TraceViewer/StateGraphViewer/jquery-1.8.2.min.js" type="text/javascript"></script>
  <script src="icurb://TraceViewer/StateGraphViewer/jquery.ui.position.js" type="text/javascript"></script>
  <script src="icurb://TraceViewer/StateGraphViewer/jquery.contextMenu.js" type="text/javascript"></script>

  <link href="icurb://TraceViewer/StateGraphViewer/jquery.contextMenu.css" rel="stylesheet" type="text/css" />
  <link href="icurb://TraceViewer/StateGraphViewer/Styles.css" rel="stylesheet" type="text/css" />

  <script type="text/javascript">
    var SeeCProto = "";

    // Clear the debug log.
    //
    function LogClear() {
      document.getElementById("Log").innerHTML = "";
    }

    // Add a debug message to the log.
    //
    function Log(Message) {
      var Container = document.getElementById("Log");
      
      Container.innerHTML = Container.innerHTML
			    + "<span>" + Message
                            + "</span><br>";
    }

    // Build the URL for a SeeC function request.
    //
    function SeeCURL(fn, args) {
      var str = SeeCProto + "://" + fn;

      for (var i = 0; i < args.length; ++i)
        str += "/" + args[i];

      str += "?callback=?";
      return str;
    }

    // Event handlers for the context menu items.
    //

    function DoRewindInitialisation() {
      Log("Rewind init");
    }

    function DoRewindLastModify() {
      Log("Rewind last");
    }

    function DoForwardNextModify() {
      Log("Forward next");
    }

    function DoForwardDeallocation() {
      Log("Forward deallocation");
    }

    // Called from seec-trace-viewer to set a new state display.
    //
    var SetStateImplTimer = null;
    
    function CMMoveToAllocation(valueid) {
      $.getJSON(SeeCURL("move_to_allocation", [valueid]),
        function(data) {
          /* The result is not important. */
        });
    }

    function CMMoveToDeallocation(valueid) {
      $.getJSON(SeeCURL("move_to_deallocation", [valueid]),
        function(data) {
          /* The result is not important. */
        });
    }
    
    function CMSetLayoutEngineValue(engineid, valueid) {
      $.getJSON(SeeCURL("set_layout_engine_value", [engineid, valueid]),
        function(data) {
          /* The result is not important. */
        });
    }
    
    function SetStateImpl(SVGString) {
      SetStateImplTimer = null;
      
      var Container = document.getElementById("SVGContainer");
      Container.innerHTML = SVGString;

      $('title').remove();

      var refs = $('a');
      refs.removeAttr("xlink:title");
      refs.on('click', function(e){
        e.preventDefault();
        
        var $this = $(this);
        var href = $this.attr('xlink:href');
        if (!href) {
          Log("No xlink:href found.");
          return;
        }

        var splitref = href.split(' ');
        if (splitref.length != 2) {
          Log("Bad reference length.");
          return;
        }

        var _offset = $this.offset(),
            position = {
              x: _offset.left + 10,
              y: _offset.top + 10
            };

        if (splitref[0] == "value") {
          $.getJSON(SeeCURL("list_layout_engines_supporting_value", [splitref[1]]),
          function(data) {
            if (data.success) {
              // Setup the menu items that always exist.
              var menuitems = {
                "move-to-allocation": {
                  "name": "Move to allocation",
                  "callback": function(key, options) {
                    CMMoveToAllocation(splitref[1]);
                  }
                },
                "move-to-deallocation": {
                  "name": "Move to deallocation",
                  "callback": function(key, options) {
                    CMMoveToDeallocation(splitref[1]);
                  }
                }
              };
              
              // Setup menu items based on the layout engines available.
              var engines = data.result;
              
              if (engines.length > 1) {
                var engineitems = {};
              
                for (var i = 0; i < engines.length; ++i) {
                  engineitems[engines[i].id] = {
                    "name": engines[i].name,
                    "callback": function(key, options) {
                      CMSetLayoutEngineValue(key, splitref[1]);
                    }
                  };
                }
                
                menuitems["select-engine"] = {
                  "name": "Layout as...",
                  "items": engineitems
                };
              }
              
              // Build and show the menu.
              $this.data('buildValueCM', function() {
                return { "items": menuitems };
              });
              
              $this.contextMenu(position);
            }
          });
        }
        else {
          Log("Don't understand ref: " + splitref[0]);
        }
      });
    }
    
    function SetState(SVGString) {
      if (SetStateImplTimer != null)
        window.clearTimeout(SetStateImplTimer);
      
      LogClear();
      
      SetStateImplTimer = setTimeout(function() { SetStateImpl(SVGString); },
                                     0);
    }

    // Called from seec-trace-viewer to clear the state display.
    //
    function ClearState() {
      document.getElementById("SVGContainer").innerHTML = "";
    }

    // Initial page setup.
    //
    function DoSetup() {
      if (window.location.hash.length)
        SeeCProto = window.location.hash.substring(1);

      $.contextMenu({
        selector: 'a',
        trigger: 'none',
        build: function($trigger, e) {
          return $trigger.data('buildValueCM')();
        }
      });
    }

    function WaitForSetup() {
      if (typeof jQuery === 'function') {
        $(DoSetup);
      }
      else {
        setTimeout(WaitForSetup, 50);
      }
    }

    WaitForSetup();
  </script>
 </head>
 <body>
  <div id="SVGContainer"></div>
  <div id="Log"></div>
 </body>
</html>

